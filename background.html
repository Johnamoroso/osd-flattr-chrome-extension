<html>
    <head>
        <script src="md5.js"></script>
        <script>
            var correctThingUrl;

			function isBlocked(url) {
				var i = 0,
					domains = JSON.parse(localStorage["whiteListDomains"] || "[]");

				if (!JSON.parse(localStorage["enableWhiteList"] || "false")) {
					return false;
				}

				for (i = 0; i < domains.length; i += 1) {
					if (url.match("(http|https)://(www.)?(" + domains[i] + ")")) {
						return false;
					}
				}

				return true;
			}

            function showIconIfAnyUrlExists(urls, tabId) {
                var xhr = new XMLHttpRequest(),
                    url = urls.pop(0),
                    thingUrl = 'https://flattr.com/thing/' + hex_md5(url);

                xhr.open("GET", thingUrl, true); // HEAD makes a 400 Bad Request...
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4) {
                        if (xhr.status == 200 || xhr.status == 304) {
                            chrome.pageAction.show(tabId);
                            correctThingUrl = thingUrl;
                        } else if (urls.length) {
                            showIconIfAnyUrlExists(urls, tabId);
                        }
                    }
                }
                xhr.send();
            }

            // Listen for any changes to the URL of any tab. If URL
            // exists, we show our extension icon in the address field.
            chrome.tabs.onUpdated.addListener(function (tabId, changeInfo, tab) {
                var url = tab.url,
                    urls = [url];

				if (isBlocked(url)) {
					return;
				}

                // Make sure both the URL with trailing slash and without are
                // being looked for.
                if (url.charAt(url.length-1) == '/') {
                    urls.push(url.slice(0, url.length-1));
                } else {
                    urls.push(url + '/');
                }

                showIconIfAnyUrlExists(urls, tabId);
            });

            // When the icon in address field is clicked, we open the flattr.com
            // thing page in a new tab/window.
            chrome.pageAction.onClicked.addListener(function (tab) {
                window.open(correctThingUrl);
            });

        </script>
    </head>
</html>
