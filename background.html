<html>
    <head>
        <script>
            var thingUrl;

            function isBlocked(url) {
                var i = 0,
                    domains = JSON.parse(localStorage["whiteListDomains"] || "[]");

                if (!JSON.parse(localStorage["enableWhiteList"] || "false")) {
                    return false;
                }

                for (i = 0; i < domains.length; i += 1) {
                    if (url.match("(http|https)://(www.)?(" + domains[i] + ")")) {
                        return false;
                    }
                }

                return true;
            }

            function showIconIfAnyUrlExists(url, tabId) {
                var xhr = new XMLHttpRequest(),
                    lookupUrl = 'https://api.flattr.com/rest/v2/things/lookup?q=' + encodeURIComponent(url);

                xhr.open("GET", lookupUrl, true); // HEAD makes a 400 Bad Request...
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4) {
                        if (xhr.status == 200 || xhr.status == 304) {
                            var response = JSON.parse(xhr.responseText);
                            if (response.message !== "not_found") {
                                chrome.pageAction.show(tabId);
                                thingUrl = response.link;
                            }
                        }
                    }
                }
                xhr.send();
            }

            // Listen for any changes to the URL of any tab. If URL
            // exists, we show our extension icon in the address field.
            chrome.tabs.onUpdated.addListener(function (tabId, changeInfo, tab) {
                var url = tab.url;

                if (isBlocked(url)) {
                    return;
                }

                showIconIfAnyUrlExists(url, tabId);
            });

            // When the icon in address field is clicked, we open the flattr.com
            // thing page in a new tab/window.
            chrome.pageAction.onClicked.addListener(function (tab) {
                window.open(thingUrl);
            });

        </script>
    </head>
</html>
