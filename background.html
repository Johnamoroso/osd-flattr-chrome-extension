<html>
	<head>
		<script src="md5.js"></script>
		<script>

			function convertToThingUrl(url) {
				// Flattr uses URLs w/o trailing slash
				url = url.slice(0, url.length-1);
				return 'https://flattr.com/thing/' + hex_md5(url);
			}

			// Listen for any changes to the URL of any tab. If URL
			// exists, we show our extension icon in the address field.
			chrome.tabs.onUpdated.addListener(function (tabId, changeInfo, tab) {
				var url = convertToThingUrl(tab.url);
				var xhr = new XMLHttpRequest();
				xhr.open("GET", url, true);
				xhr.onreadystatechange = function() {
					if (xhr.readyState == 4) {
						if (xhr.status == 200 || xhr.status == 304) {
							chrome.pageAction.show(tabId);
						}
					}
				}
				xhr.send();
			});

			chrome.pageAction.onClicked.addListener(function(tab) {
				window.open(convertToThingUrl(tab.url));
			});

		</script>
	</head>
</html>
